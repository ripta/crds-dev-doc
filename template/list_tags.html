<div class="content-wrapper">
    <div class="container">
        <p>
            Source: <a href="https://github.com/{{ .Repo }}"><span class="label label-primary">github.com/{{ .Repo }}</span></a>
        </p>
        <p>Tags indexed: <b>{{ .Total }}</b></p>
        <div id="tags"></div>
    </div>
</div>

{{ template "_scripts" . }}
<script src="https://unpkg.com/react-table@7/dist/react-table.production.min.js"></script>
<script type="module">
    const { html } = htmReact;
    const { useTable, useSortBy, useGlobalFilter  } = ReactTable;

    const { Repo, Tags, } = {{ . }};
    const data = Object.keys(Tags).map(key => {
        return {
            Name: Tags[key].Name,
            Timestamp: Tags[key].Timestamp,
            LabelHTML: (Tags[key].Labels ?? []).map((label) => html`<kbd class="text-bg-secondary">${label}</kbd>`),
        };
    });

    const columns = [
        {
            Header: 'Tag',
            accessor: 'Name',
            Cell: ({ row: { original }, value }) => html`<a href=${`/repo/github.com/${Repo}@${original.Name}`}>${value}</a> ${original.LabelHTML}`,
        },
        {
            Header: 'Tagged At',
            accessor: 'Timestamp'
        },
    ];

    function TagsHeader(column) {
        return html`<th ...${column.getHeaderProps(column.getSortByToggleProps())}>
        ${column.render('Header')}
            <span class="sort-header ${column.isSorted ? 'sort-header-active' : ''}">
            ${(column.isSorted
            ? column.isSortedDesc
                ? html`<i class="fas fa-sort-down"></i>`
                : html`<i class="fas fa-sort-up"></i>`
            : html`<i class="fas fa-sort"></i>`)}
            </span>
        </th>`
    }

    function TagsTable() {
        const table = useTable({
            columns,
            data,
            initialState: {
                sortBy: [
                    {
                        id: 'Timestamp',
                        desc: true
                    }
                ]
            }
        }, useSortBy, useGlobalFilter);
        const {
            getTableProps,
            getTableBodyProps,
            headerGroups,
            rows,
            prepareRow,
            setGlobalFilter,
            state: { globalFilter }
        } = table;

        return html`
            <form class="form-inline specific-w-md-400 w-sm-100 mb-md-3 mb-2" onSubmit=${e => e.preventDefault}>
            <input type="search" class="form-control" placeholder="Filter by any field value" onInput=${e => setGlobalFilter(e.target.value)} value=${globalFilter}></input>
        </form>
        <div class="table-responsive">
            <table class="table table-striped table-outer-bordered" ...${getTableProps()}>
                <thead>
                    ${headerGroups.map(group => html`
                    <tr ...${group.getHeaderGroupProps()}>
                        ${group.headers.map(TagsHeader)}
                    </tr>
                    `)}
                </thead>
                <tbody ...${getTableBodyProps()}>
                    ${rows.map(row => {
            prepareRow(row)
            return html`
                        <tr ...${row.getRowProps()}>
                            ${row.cells.map(cell => html`
                            <td ...${cell.getCellProps()}>${cell.render('Cell')}</td>
                            `)}
                        </tr>
                        `
        })}
                </tbody>
            </table>
        </div>`;
    }

    const root = ReactDOM.createRoot(document.getElementById("tags"));
    root.render(html`<${TagsTable} />`);
</script>
<style>
    #tags .sort-header {
        margin-left: 1rem;
    }

    #tags .sort-header:not(.sort-header-active) {
        opacity: 0.5;
    }
</style>